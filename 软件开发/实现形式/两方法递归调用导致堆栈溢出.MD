# 在某服务中，两方法递归调用导致堆栈溢出

    服务层、service、方法、模块、增、查、insert、save、select、get

## 背景

这个问题已经过去一段时间了，而且当时反馈过来很快就改好了，但是如何在开发和维护阶段避免出现这种问题？有没有适用性原则或者规范？这个问题困扰了我许久，特此记录下来。

项目中的某服务原有 保存方法 中，调用了查询方法；在 查询方法 中，直接调用了dao层（mapper）；

某次维护，保存方法未动，在没有阅读保存方法的逻辑的情况下，在查询方法中调用了保存方法，初上线时没有问题，直到一段时间以后，用户反映系统报错，无法保存。

## 问题描述

一、保存（兼有修改功能）方法的逻辑：

1. 检查参数合法性
2. **通过查询方法获取库中数据**
3. 若查询有数据，向要保存的map中填入id，否则填id=0
4. 向map中装填其他字段
5. 执行低一层保存方法（这个方法会按id查询，查询出数据则修改，否则执行新增）

二、维护前查询方法直接调用dao查了，但是新入需求需要本库可能没有的信息，需要加逻辑，修改为：

1. 先查本数据库，有对应记录且有对应数据就直接返回（对应记录指某行，对应数据指该行某列）
2. 本库没有对应数据，查外库，外库无数据就返回上一步查询结果
3. **外库有数据，本库无记录，向空白记录填入数据，调用保存方法，然后重新查本库，返回**
4. 外库有数据，本库有记录，向该记录填入数据，**调用保存方法**
5. 返回记录

查看在线系统的日志，发现 `一、2` 和 `二、3` 直接出现递归调用，导致程序爆栈。

## 分析

一看日志我就觉得这肯定不是我写的

## 解决方案

解决方案很简单，将`二、3`中调用保存方法的部分注掉，直接新建各空白记录，装填数据返回即可，重点在于[分析](#分析)，避免以后再出现类似的问题。
